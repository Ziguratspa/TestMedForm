<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Ficha Médica</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 1.1em;
            opacity: 0.8;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }
        
        .form-section {
            flex: 2;
            min-width: 300px;
            padding: 20px;
        }
        
        .search-section {
            flex: 1;
            min-width: 250px;
            padding: 20px;
            background: var(--light);
            border-radius: 8px;
            margin-left: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        
        /* Estilos para campos inválidos */
        .error {
            border-color: var(--danger) !important;
            background-color: #fdf2f2;
        }
        
        .error-message {
            color: var(--danger);
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }
        
        .show-error {
            display: block;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: var(--light);
            color: var(--dark);
        }
        
        .btn-secondary:hover {
            background: #bdc3c7;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .buttons {
            display: flex;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .search-box {
            display: flex;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .search-box button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        .search-results {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .patient-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .patient-item:hover {
            background: #dfe6e9;
        }
        
        .patient-item:focus {
            background: #dfe6e9;
            outline: 2px solid var(--secondary);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }
        
        .required::after {
            content: " *";
            color: var(--danger);
        }
        
        .patient-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid var(--warning);
        }
        
        .edit-timestamp {
            text-align: center;
            padding: 15px;
            margin-top: 20px;
            color: #7f8c8d;
            font-size: 0.9em;
            border-top: 1px solid #ecf0f1;
            background-color: #f9f9f9;
        }
        
        /* Estilos de accesibilidad */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Indicador de carga */
        .loading {
            position: relative;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .search-section {
                margin-left: 0;
                margin-top: 20px;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
            
            .modal-buttons button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Formulario de Ficha Médica</h1>
            <p class="subtitle">Sistema de registro y gestión de pacientes</p>
        </header>
        
        <div class="content">
            <section class="form-section">
                <form id="medicalForm" role="form" aria-label="Formulario de registro de paciente">
                    <div class="form-group">
                        <label for="rut" class="required">RUT</label>
                        <input type="text" id="rut" name="rut" placeholder="12345678-9" required 
                               aria-describedby="rut-error" maxlength="12">
                        <div id="rut-error" class="error-message" role="alert">RUT inválido</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="nombres" class="required">Nombres</label>
                        <input type="text" id="nombres" name="nombres" placeholder="Juan Antonio" required 
                               aria-describedby="nombres-error" maxlength="50">
                        <div id="nombres-error" class="error-message" role="alert">Los nombres son obligatorios</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="apellidos" class="required">Apellidos</label>
                        <input type="text" id="apellidos" name="apellidos" placeholder="Pérez González" required 
                               aria-describedby="apellidos-error" maxlength="50">
                        <div id="apellidos-error" class="error-message" role="alert">Los apellidos son obligatorios</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="direccion" class="required">Dirección</label>
                        <input type="text" id="direccion" name="direccion" placeholder="Av. Principal 123" required 
                               aria-describedby="direccion-error" maxlength="100">
                        <div id="direccion-error" class="error-message" role="alert">La dirección es obligatoria</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ciudad" class="required">Ciudad</label>
                        <input type="text" id="ciudad" name="ciudad" placeholder="Santiago" required 
                               aria-describedby="ciudad-error" maxlength="50">
                        <div id="ciudad-error" class="error-message" role="alert">La ciudad es obligatoria</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="telefono" class="required">Teléfono</label>
                        <input type="tel" id="telefono" name="telefono" placeholder="+56 9 1234 5678" required 
                               aria-describedby="telefono-error" maxlength="15">
                        <div id="telefono-error" class="error-message" role="alert">El teléfono es obligatorio</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="ejemplo@correo.com" 
                               aria-describedby="email-error" maxlength="100">
                        <div id="email-error" class="error-message" role="alert">Email inválido</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="fechaNacimiento" class="required">Fecha de Nacimiento</label>
                        <input type="date" id="fechaNacimiento" name="fechaNacimiento" required 
                               aria-describedby="fechaNacimiento-error" max="">
                        <div id="fechaNacimiento-error" class="error-message" role="alert">La fecha de nacimiento es obligatoria</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="estadoCivil">Estado Civil</label>
                        <select id="estadoCivil" name="estadoCivil" aria-describedby="estadoCivil-help">
                            <option value="">Seleccione...</option>
                            <option value="soltero">Soltero(a)</option>
                            <option value="casado">Casado(a)</option>
                            <option value="divorciado">Divorciado(a)</option>
                            <option value="viudo">Viudo(a)</option>
                            <option value="union">Unión Civil</option>
                        </select>
                        <div id="estadoCivil-help" class="sr-only">Campo opcional</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="comentarios">Comentarios</label>
                        <textarea id="comentarios" name="comentarios" rows="4" 
                                  placeholder="Observaciones médicas relevantes..." 
                                  maxlength="500" aria-describedby="comentarios-count"></textarea>
                        <div id="comentarios-count" class="sr-only">Máximo 500 caracteres</div>
                    </div>
                    
                    <div class="buttons">
                        <button type="button" id="btnGuardar" class="btn btn-primary" 
                                aria-describedby="save-status">Guardar</button>
                        <button type="button" id="btnLimpiar" class="btn btn-secondary">Limpiar</button>
                        <button type="button" id="btnCerrar" class="btn btn-danger">Cerrar</button>
                    </div>
                    <div id="save-status" class="sr-only" role="status" aria-live="polite"></div>
                    
                    <div class="edit-timestamp" id="editTimestamp">
                        Última edición: <span id="timestampValue">Ningún registro editado</span>
                    </div>
                </form>
            </section>
            
            <section class="search-section">
                <h2>Búsqueda de Pacientes</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Buscar por apellido..." 
                           aria-label="Campo de búsqueda por apellido">
                    <button id="btnBuscar" class="btn btn-primary" 
                            aria-describedby="search-status">Buscar</button>
                </div>
                <div id="search-status" class="sr-only" role="status" aria-live="polite"></div>
                
                <div class="search-results" id="searchResults" role="region" 
                     aria-label="Resultados de búsqueda" aria-live="polite">
                    <!-- Los resultados de búsqueda aparecerán aquí -->
                </div>
            </section>
        </div>
    </div>
    
    <!-- Modal para confirmar sobrescritura -->
    <div class="modal" id="overwriteModal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
        <div class="modal-content">
            <h2 id="modal-title">⚠️ Paciente Existente</h2>
            <div class="patient-info" id="existingPatientInfo">
                <!-- Información del paciente existente -->
            </div>
            <p>El RUT ingresado ya existe en el sistema. ¿Desea sobrescribir los datos existentes?</p>
            <div class="modal-buttons">
                <button id="btnCancelar" class="btn btn-secondary">Cancelar</button>
                <button id="btnSobrescribir" class="btn btn-primary">Sí, Sobescribir</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Referencias a elementos del DOM
            const medicalForm = document.getElementById('medicalForm');
            const btnGuardar = document.getElementById('btnGuardar');
            const btnLimpiar = document.getElementById('btnLimpiar');
            const btnCerrar = document.getElementById('btnCerrar');
            const btnBuscar = document.getElementById('btnBuscar');
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const overwriteModal = document.getElementById('overwriteModal');
            const btnCancelar = document.getElementById('btnCancelar');
            const btnSobrescribir = document.getElementById('btnSobrescribir');
            const existingPatientInfo = document.getElementById('existingPatientInfo');
            const timestampValue = document.getElementById('timestampValue');
            const saveStatus = document.getElementById('save-status');
            const searchStatus = document.getElementById('search-status');
            
            let currentRut = null;
            let pacienteExistente = null;
            
            // Configurar fecha máxima (hoy)
            document.getElementById('fechaNacimiento').max = new Date().toISOString().split('T')[0];
            
            // Cargar pacientes desde localStorage con manejo de errores
            function cargarPacientes() {
                try {
                    const pacientes = localStorage.getItem('pacientes');
                    return pacientes ? JSON.parse(pacientes) : {};
                } catch (error) {
                    console.error('Error al cargar pacientes:', error);
                    mostrarError('Error al acceder a los datos almacenados');
                    return {};
                }
            }
            
            // Guardar pacientes en localStorage con manejo de errores
            function guardarPacientes(pacientes) {
                try {
                    localStorage.setItem('pacientes', JSON.stringify(pacientes));
                    return true;
                } catch (error) {
                    console.error('Error al guardar pacientes:', error);
                    if (error.name === 'QuotaExceededError') {
                        mostrarError('Espacio de almacenamiento insuficiente');
                    } else {
                        mostrarError('Error al guardar los datos');
                    }
                    return false;
                }
            }
            
            // Función para mostrar errores de forma accesible
            function mostrarError(mensaje) {
                saveStatus.textContent = mensaje;
                saveStatus.classList.remove('sr-only');
                saveStatus.style.color = 'var(--danger)';
                setTimeout(() => {
                    saveStatus.classList.add('sr-only');
                }, 5000);
            }
            
            // Función para mostrar éxito
            function mostrarExito(mensaje) {
                saveStatus.textContent = mensaje;
                saveStatus.classList.remove('sr-only');
                saveStatus.style.color = 'var(--success)';
                setTimeout(() => {
                    saveStatus.classList.add('sr-only');
                }, 3000);
            }
            
            // Actualizar la marca de tiempo de edición
            function actualizarTimestamp(fecha) {
                if (fecha) {
                    const fechaObj = new Date(fecha);
                    timestampValue.textContent = fechaObj.toLocaleString('es-ES');
                } else {
                    timestampValue.textContent = 'Ningún registro editado';
                }
            }
            
            // Validar RUT chileno (corregido)
            function validarRUT(rut) {
                // Expresión regular corregida
                if (!/^[0-9]+-[0-9kK]{1}$/.test(rut)) return false;
                
                const tmp = rut.split('-');
                let digv = tmp[1].toUpperCase();
                const cuerpo = tmp[0];
                let suma = 0;
                let multiplo = 2;
                
                for (let i = 1; i <= cuerpo.length; i++) {
                    const index = multiplo * parseInt(cuerpo.charAt(cuerpo.length - i));
                    suma += index;
                    if (multiplo < 7) multiplo += 1;
                    else multiplo = 2;
                }
                
                let expectedDV = 11 - (suma % 11);
                if (expectedDV === 11) expectedDV = '0';
                else if (expectedDV === 10) expectedDV = 'K';
                else expectedDV = String(expectedDV);
                
                return digv === expectedDV;
            }
            
            // Validaciones en tiempo real
            function configurarValidaciones() {
                const campos = ['rut', 'nombres', 'apellidos', 'direccion', 'ciudad', 'telefono', 'email'];
                
                campos.forEach(campo => {
                    const input = document.getElementById(campo);
                    const errorDiv = document.getElementById(campo + '-error');
                    
                    input.addEventListener('blur', () => validarCampo(input, errorDiv));
                    input.addEventListener('input', () => limpiarError(input, errorDiv));
                });
            }
            
            function validarCampo(input, errorDiv) {
                const valor = input.value.trim();
                let esValido = true;
                let mensaje = '';
                
                if (input.required && !valor) {
                    esValido = false;
                    mensaje = `El campo ${input.labels[0].textContent.replace(' *', '')} es obligatorio`;
                } else if (input.id === 'rut' && valor && !validarRUT(valor)) {
                    esValido = false;
                    mensaje = 'El RUT ingresado no es válido';
                } else if (input.type === 'email' && valor && !input.validity.valid) {
                    esValido = false;
                    mensaje = 'El email no tiene un formato válido';
                }
                
                mostrarError(input, errorDiv, esValido, mensaje);
                return esValido;
            }
            
            function mostrarErrorCampo(input, errorDiv, esValido, mensaje) {
                if (esValido) {
                    input.classList.remove('error');
                    errorDiv.classList.remove('show-error');
                } else {
                    input.classList.add('error');
                    errorDiv.textContent = mensaje;
                    errorDiv.classList.add('show-error');
                }
            }
            
            function limpiarError(input, errorDiv) {
                input.classList.remove('error');
                errorDiv.classList.remove('show-error');
            }
            
            // Limpiar formulario
            function limpiarFormulario() {
                medicalForm.reset();
                currentRut = null;
                pacienteExistente = null;
                actualizarTimestamp(null);
                
                // Limpiar errores visuales
                document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
                document.querySelectorAll('.show-error').forEach(el => el.classList.remove('show-error'));
                
                mostrarExito('Formulario limpiado correctamente');
            }
            
            // Mostrar modal de sobrescritura con información del paciente existente
            function mostrarModalSobrescritura(paciente) {
                pacienteExistente = paciente;
                existingPatientInfo.innerHTML = `
                    <strong>Paciente actual:</strong><br>
                    ${paciente.nombres} ${paciente.apellidos}<br>
                    ${paciente.rut} | Tel: ${paciente.telefono}<br>
                    Registrado el: ${new Date(paciente.fechaRegistro).toLocaleDateString()}
                `;
                overwriteModal.style.display = 'flex';
                overwriteModal.setAttribute('aria-hidden', 'false');
                btnCancelar.focus();
            }
            
            // Ocultar modal de sobrescritura
            function ocultarModalSobrescritura() {
                overwriteModal.style.display = 'none';
                overwriteModal.setAttribute('aria-hidden', 'true');
                pacienteExistente = null;
                document.getElementById('rut').focus();
            }
            
            // Validar todo el formulario
            function validarFormularioCompleto() {
                let formularioValido = true;
                const campos = ['rut', 'nombres', 'apellidos', 'direccion', 'ciudad', 'telefono'];
                
                campos.forEach(campo => {
                    const input = document.getElementById(campo);
                    const errorDiv = document.getElementById(campo + '-error');
                    if (!validarCampo(input, errorDiv)) {
                        formularioValido = false;
                    }
                });
                
                // Validar fecha de nacimiento
                const fechaNac = document.getElementById('fechaNacimiento');
                if (!fechaNac.value) {
                    mostrarErrorCampo(fechaNac, document.getElementById('fechaNacimiento-error'), false, 'La fecha de nacimiento es obligatoria');
                    formularioValido = false;
                }
                
                return formularioValido;
            }
            
            // Guardar paciente con validaciones mejoradas
            function guardarPaciente(sobrescribir = false) {
                if (!validarFormularioCompleto()) {
                    mostrarError('Por favor, corrija los errores en el formulario');
                    return;
                }
                
                // Mostrar estado de carga
                btnGuardar.disabled = true;
                btnGuardar.classList.add('loading');
                
                const rut = document.getElementById('rut').value.trim();
                const nombres = document.getElementById('nombres').value.trim();
                const apellidos = document.getElementById('apellidos').value.trim();
                const direccion = document.getElementById('direccion').value.trim();
                const ciudad = document.getElementById('ciudad').value.trim();
                const telefono = document.getElementById('telefono').value.trim();
                const email = document.getElementById('email').value.trim();
                const fechaNacimiento = document.getElementById('fechaNacimiento').value;
                const estadoCivil = document.getElementById('estadoCivil').value;
                const comentarios = document.getElementById('comentarios').value.trim();
                
                const pacientes = cargarPacientes();
                
                // Verificar si el RUT ya existe
                if (pacientes[rut] && !sobrescribir && rut !== currentRut) {
                    btnGuardar.disabled = false;
                    btnGuardar.classList.remove('loading');
                    mostrarModalSobrescritura(pacientes[rut]);
                    return;
                }
                
                // Guardar paciente
                const pacienteData = {
                    rut,
                    nombres,
                    apellidos,
                    direccion,
                    ciudad,
                    telefono,
                    email,
                    fechaNacimiento,
                    estadoCivil,
                    comentarios,
                    fechaRegistro: pacientes[rut] && pacientes[rut].fechaRegistro ? 
                                  pacientes[rut].fechaRegistro : new Date().toISOString(),
                    fechaActualizacion: new Date().toISOString()
                };
                
                pacientes[rut] = pacienteData;
                
                if (guardarPacientes(pacientes)) {
                    mostrarExito(sobrescribir ? 'Datos del paciente actualizados correctamente' : 'Paciente guardado correctamente');
                    actualizarTimestamp(pacienteData.fechaActualizacion);
                    setTimeout(() => limpiarFormulario(), 1000);
                    ocultarModalSobrescritura();
                }
                
                btnGuardar.disabled = false;
                btnGuardar.classList.remove('loading');
            }
            
            // Buscar pacientes por apellido con mejoras
            function buscarPacientes() {
                const apellido = searchInput.value.trim().toLowerCase();
                
                if (!apellido) {
                    mostrarError('Por favor, ingrese un apellido para buscar');
                    searchInput.focus();
                    return;
                }
                
                searchStatus.textContent = 'Buscando...';
                searchStatus.classList.remove('sr-only');
                btnBuscar.disabled = true;
                
                setTimeout(() => {
                    const pacientes = cargarPacientes();
                    const resultados = Object.values(pacientes).filter(paciente => 
                        paciente.apellidos.toLowerCase().includes(apellido)
                    );
                    
                    mostrarResultados(resultados);
                    searchStatus.textContent = `Se encontraron ${resultados.length} resultado(s)`;
                    setTimeout(() => {
                        searchStatus.classList.add('sr-only');
                    }, 3000);
                    btnBuscar.disabled = false;
                }, 300);
            }
            
            // Mostrar resultados de búsqueda con accesibilidad mejorada
            function mostrarResultados(resultados) {
                searchResults.innerHTML = '';
                
                if (resultados.length === 0) {
                    searchResults.innerHTML = '<p role="status">No se encontraron pacientes</p>';
                    return;
                }
                
                resultados.forEach((paciente, index) => {
                    const div = document.createElement('div');
                    div.className = 'patient-item';
                    div.setAttribute('role', 'button');
                    div.setAttribute('tabindex', '0');
                    div.setAttribute('aria-label', `Cargar datos de ${paciente.nombres} ${paciente.apellidos}`);
                    
                    div.innerHTML = `
                        <strong>${paciente.nombres} ${paciente.apellidos}</strong>
                        <div>RUT: ${paciente.rut}</div>
                        <div>Tel: ${paciente.telefono}</div>
                        <small>Actualizado: ${new Date(paciente.fechaActualizacion || paciente.fechaRegistro).toLocaleDateString()}</small>
                    `;
                    
                    // Eventos de clic y teclado
                    div.addEventListener('click', () => cargarPaciente(paciente));
                    div.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            cargarPaciente(paciente);
                        }
                    });
                    
                    searchResults.appendChild(div);
                });
            }
            
            // Cargar paciente en el formulario
            function cargarPaciente(paciente) {
                document.getElementById('rut').value = paciente.rut;
                document.getElementById('nombres').value = paciente.nombres;
                document.getElementById('apellidos').value = paciente.apellidos;
                document.getElementById('direccion').value = paciente.direccion;
                document.getElementById('ciudad').value = paciente.ciudad;
                document.getElementById('telefono').value = paciente.telefono;
                document.getElementById('email').value = paciente.email || '';
                document.getElementById('fechaNacimiento').value = paciente.fechaNacimiento;
                document.getElementById('estadoCivil').value = paciente.estadoCivil || '';
                document.getElementById('comentarios').value = paciente.comentarios || '';
                
                currentRut = paciente.rut;
                actualizarTimestamp(paciente.fechaActualizacion || paciente.fechaRegistro);
                mostrarExito(`Datos de ${paciente.nombres} ${paciente.apellidos} cargados`);
                
                // Scroll al formulario
                document.getElementById('nombres').focus();
            }
            
            // Función para formatear RUT automáticamente (mejorada)
            function formatearRUT(input) {
                let rut = input.value.replace(/[^0-9kK]/gi, '').toUpperCase();
                
                if (rut.length > 1) {
                    const cuerpo = rut.slice(0, -1);
                    const dv = rut.slice(-1);
                    input.value = cuerpo + '-' + dv;
                } else if (rut.length === 1) {
                    input.value = rut;
                }
            }
            
            // Event Listeners
            btnGuardar.addEventListener('click', () => guardarPaciente(false));
            btnLimpiar.addEventListener('click', () => {
                if (confirm('¿Está seguro que desea limpiar el formulario? Se perderán los datos no guardados.')) {
                    limpiarFormulario();
                }
            });
            btnCerrar.addEventListener('click', () => {
                if (confirm('¿Está seguro que desea cerrar el formulario? Se perderán los datos no guardados.')) {
                    window.close();
                }
            });
            
            btnBuscar.addEventListener('click', buscarPacientes);
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    buscarPacientes();
                }
            });
            
            btnCancelar.addEventListener('click', ocultarModalSobrescritura);
            btnSobrescribir.addEventListener('click', () => guardarPaciente(true));
            
            // Cerrar modal con Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && overwriteModal.style.display === 'flex') {
                    ocultarModalSobrescritura();
                }
            });
            
            // Cerrar modal al hacer clic fuera
            overwriteModal.addEventListener('click', (e) => {
                if (e.target === overwriteModal) {
                    ocultarModalSobrescritura();
                }
            });
            
            // Formatear RUT automáticamente
            document.getElementById('rut').addEventListener('input', function(e) {
                formatearRUT(e.target);
            });
            
            // Inicializar validaciones
            configurarValidaciones();
            
            // Mostrar mensaje de carga inicial
            mostrarExito('Sistema de ficha médica cargado correctamente');
        });
    </script>
</body>
</html>